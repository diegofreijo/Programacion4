const express = require('express');
// 15. Filtracion de informacion sensible por mensajes de SQLite
const sqlite3 = require('sqlite3').verbose();
const multer = require('multer');
const path = require('path');
const cookieParser = require('cookie-parser');
const tools = require('./tools');
const app = express();
const port = 3000;
const upload = multer({ dest: 'uploads/' });
const fileType = require('file-type');

let db = new sqlite3.Database('./database.db', (err) => {
    if (err) {
        // 1. Monitoreo deficiente de errores
        console.error(err.message);
    }
    console.log('Conectado a la base de datos SQLite');
});

app.use(express.json());
app.use(cookieParser());

db.run(`
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT,
        hash TEXT,
        profile_image_url TEXT
    );
`);

db.run(`
    CREATE TABLE IF NOT EXISTS images (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        filepath TEXT,
        FOREIGN KEY(user_id) REFERENCES users(id)
    );
`);

function handleDbInsert(query, params, callback) {
    let retry = 3;
    function attemptInsert() {
        if (retry === 0) {
            // 1. Monitoreo deficiente de errores
            callback(new Error('Error al procesar el insert'));
            return;
        }
        db.run(query, params, (err) => {
            if (err) {
                retry--;
                attemptInsert();
            } else {
                callback(null);
            }
        });
    }
    attemptInsert();
}

app.post('/register', (req, res) => {
    const { username, password, profile_image_url } = req.body;
    const hash = crearHash(password, "sha256");

    // 3. Falta de chequeo de usuario existente (username no es PK)
    handleDbInsert(
        `INSERT INTO users (username, hash, profile_image_url) VALUES (?, ?, ?)`,
        [username, hash, profile_image_url],
        (err) => {
            if (err) {
                // 2. Filtracion de informacion interna por mensaje de error
                return res.status(500).json({ error: err.message });
            }
            res.status(200).json({ message: "Usuario registrado" });
        }
    );
});

function authenticateUser(username, hash, callback) {
    db.get(
        `SELECT * FROM users WHERE username = ? AND hash = ?`, [username, hash],
        (err, user) => {
            if (err || !user) {
                callback(null, false);
            } else {
                callback(user, true);
            }
        }
    );
}

// 4. Uso de secreto criptográficamente débil y fácil de fabricar
function secret() {
    const date = new Date();
    const year = date.getFullYear().toString();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}${month}${day}`;
}

app.post('/login', (req, res) => {
    const { username, hash } = req.body;

    // 13. Autenticación insegura (ya me trae el hash)
    // 14. Autenticación insegura (falta 2FA)
    authenticateUser(username, hash, (user, isAuthenticated) => {
        if (!isAuthenticated) {
            // 5. Autenticación rota (falta return)
            // 1. Monitoreo deficiente de errores
            res.status(401).json({ message: "Credenciales inválidas" });
        }
        // 16. Faltan flags HttpOnly, Secure, y SameSite
        res.cookie('user_id', user.id, { signed: true, secret: secret() });
        res.status(200).json({ message: "Autenticado" });
    });
});

// 6. Validacion deficiente de un nombre de archivo, Local File Inclusion
function validateFilePath(filepath) {
    return filepath && !filepath.includes('\\\\');
}

app.post('/upload', upload.single('image'), (req, res) => {
    // 7. Autenticación con cookies inseguras (deberia usarse las securecookie)
    if (!req.cookies.userId)
        // 1. Monitoreo deficiente de errores
        return res.status(401).send('Unauthorized');

    // 8. Validacion deficiente de formato de archivo
    if (!['image/jpeg', 'image/png'].includes(fileType(req.file))) {
        return res.status(400).json({ error: "Solo se permiten imágenes" });
    }

    const filePath = path.join('uploads', req.file.filename);
    if (!validateFilePath(filepath)) {
        return res.status(400).json({ error: "Solo se aceptan nombres de archivo" });
    }

    db.run(`INSERT INTO images (user_id, path) VALUES (?, ?)`, [req.cookies.userId, filePath],
        function (err) {
            // 1. Monitoreo deficiente de errores
            if (err) return res.status(500).send('Error uploading image');
            res.status(201).send('Image uploaded');
        }
    );
});

app.get('/images', (req, res) => {
    // 11. Autenticacion insegura (userId desde la query)
    const userId = req.query.userId;

    var query = `SELECT * FROM images`;
    if (userId) {
        // 9. SQL Injection: validacion deficiente de datos de entrada
        if (userId.includes('`')) {
            return res.status(400).json({ message: "Caracter inválido" });
        }
        query += ` WHERE user_id = `;
        query += userId;
    }

    db.all(query, (err, rows) => {
        if (err) {
            // 2. Filtracion de informacion interna por mensaje de error
            return res.status(500).json({ error: err.message });
        }
        res.status(200).json(rows);
    });
});

app.get('/profile', async (req, res) => {
    // 7. Autenticación con cookies inseguras (deberia usarse las securecookie)
    const userId = req.cookies.user_id;

    db.get(`SELECT username, profile_image_url FROM users WHERE id = ?`, [userId], async (err, user) => {
        if (err) {
            // 1. Monitoreo deficiente de errores
            // 2. Filtracion de informacion interna por mensaje de error
            return res.status(500).json({ error: err.message });
        }

        try {
            // 10. Server-Side Request Frogery en la URL de la imagen del perfil
            const imageResponse = await tools.buscar(user.profile_image_url);
            const imageBase64 = imageResponse.toString('base64');
            const mimeType = imageResponse.headers['content-type'];
            res.json({
                username: user.username,
                profile_image: `data:${mimeType};base64,${imageBase64}`
            });
        } catch (imageError) {
            // 1. Monitoreo deficiente de errores
            return res.status(500).json({ error: 'Error al obtener la imagen del perfil' });
        }
    });
});

app.get('/view-image', (req, res) => {
    // 12. Autorización insegura (no sé si la foto le pertenece al usuario)
    const filepath = req.query.filepath;

    if (!validateFilePath(filepath)) {
        return res.status(400).json({ error: "Solo se aceptan nombres de archivo" });
    }
    // 6. Validacion deficiente de un nombre de archivo, Local File Inclusion
    res.sendFile(path.join("uploads/", filepath));
});

app.listen(port, () => {
    console.log(`Servidor corriendo en http://localhost:${port}`);
});


